# FMLtools

Pipelines for processing data from FML-seq.

This is a work in progress: the results are correct, but there may be future improvements in speed, ease of use, and documentation.

## Required software

* [CutAdapt](https://cutadapt.readthedocs.io/en/stable/)
* [bwa-mem2](https://github.com/bwa-mem2/bwa-mem2)
* [Samtools](https://www.htslib.org/)
* [pysam](https://pysam.readthedocs.io/en/latest/api.html) (Python module)
* [genomerator](https://github.com/jwfoley/genomerator) (Python module)

## First-time setup

Index the reference genome (FASTA) according to bwa-mem2's instructions. You also need a list of restriction motif sites in the reference genome created by `get_sequence_positions.py`, e.g. for the motif CGNR

    $ ~/FMLtools/get_sequence_positions.py CGNR < hg38.fa > CGNR_hg38.bed

The motif of MspJI restriction endonuclease is CNNR, but in genomes that methylate cytosine in a specific motif it may be preferable to count only sites that include that motif, e.g. for CpG methylation you would use CGNR.

## Pipeline

Obtain paired-end FASTQ files from the Illumina software. Do not use adapter trimming. `bwa.sh` assumes the filenames will end in `_R1.fastq.gz` and `_R2.fastq.gz` for read1 and read2 respectively; rename the files or modify the regular expressions in the script otherwise.

### Trim and align reads

`align.sh` automates adapter trimming (via CutAdapt), alignment to the reference genome (via bwa-mem2), and sorting and indexing (via Samtools). Provide the prefix path of the reference genome files that are all in the same directory (e.g. for `~/genome/hg38/hg38.fa`, `~/genome/hg38/hg38.fa.fai`, `~/genome/hg38/hg38.bwt.2bit.64`, say `~/genome/hg38/hg38`) and the paths to only the read1 FASTQ files (`*_R1.fastq.gz`); the paths to read2 files are inferred. This path is hardcoded in the output CRAM file headers so ensure it is something sensible that you can reproduce if you want to read the CRAM files on another computer. Each sample (FASTQ file pair) is processed consecutively but the steps are carried out concurrently in memory, so the only outputs are CRAM and CRAI files and logs of the constituent programs.

For example, run

    $ ~/FMLtools/align.sh ~/genome/hg38/hg38 sample1_R1.fastq.gz sample2_R2.fastq.gz

and you will get 

    sample1.align.log
    sample1.crai
    sample1.cram
    sample1.trim.log
    sample2.align.log
    sample2.crai
    sample2.cram
    sample2.trim.log

### Count hits per motif site

`count_fml_hits.py` takes the list of motif sites generated by `get_sequence_positions.py` and each CRAM file generated by `align.sh` and counts the number of reads attributable to each motif site, based on the distance of each read's endpoint from the motif. For example,

    $ ~/FMLtools/count_fml_hits.py ~/genome/hg38/CGNR_hg38.bed sample1.cram sample1.CGNR.bed

The output is a BED file in which each motif's "score" is the number of hits (sequence reads) attributed to it.

It may be preferable to use only high-confidence alignments (e.g. MAPQ >= 10), compress the output file, record the summary statistics in a log file, and parallelize this step for a long list of CRAM files; see `count_fml_hits.sh` for an editable example script.

### Count motif hits per genome region

`region_counts.py` takes a BED file of interesting genome regions (e.g. promoters), a BED file of hits per motif site from `count_fml_hits.py`, and a table of chromosome lengths to compute the total motif hit count in each genome region:

    $ ~/FMLtools/region_counts.py ~/genome/hg38/hg38.chrom.sizes ~/genome/hg38/promoters.bed sample1.CGNR.bed sample1.promoter_CGNR_hits.tsv

The table of chromosome lengths should be in the format

    chr1 248387328
    chr2 242696752
    chr3 201105948

etc.

The output of `region_counts.py` is a TSV table with region names in the first column and hit counts in the second column. It may be helpful to use the `-z` option to include regions with a count of 0. Then you can easily load them into a matrix in R:

    > counts <- do.call(cbind, lapply(list("sample1.promoter_CGNR_hits.tsv", "sample2.promoter_CGNR_hits.tsv"), function(file) as.matrix(read.delim(file, header = F, row.names = 1))))

